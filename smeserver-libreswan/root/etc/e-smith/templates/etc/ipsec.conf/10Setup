{
	use strict;
	use warnings;
	use esmith::ConfigDB;

	my $configDB = esmith::ConfigDB->open_ro or die("can't open Config DB");

	my $ipsecDB = esmith::ConfigDB->open_ro('ipsec_connections')
	  or die("cant connect to ipsec database");

	my $dbKey = 'ipsec';

	# Generic setup file

# A standard config is included in the RPM but we need to generate a new one so we can modify settings

	$OUT .= "config setup";
	$OUT .= "    protostack=netkey";
	$OUT .= "    #plutodebug=none";
	$OUT .= "    #klipsdebug=none";
	$OUT .= "    dumpdir=/var/run/pluto/";
	$OUT .= "    nat_traversal=yes";

	# This should get all the connections in an array

	my @connections = $ipsecDB->keys;

	$OUT .= "    virtual_private=";

	my $virtual_private = '';

	foreach my $ipsecprop (@connections)
	{
		my $ipsecstatus = $ipsecDB->get_prop( "$ipsecprop", 'status' )
		  || "disabled";
		if ( $ipsecstatus eq "enabled" )
		{
			my $leftsubnet = $ipsecDB->get_prop( "$ipsecprop", 'leftsubnet' );
			$virtual_private .= "%v4:$leftsubnet,";
		}
	}

	# Remove last charater ','
	chop($virtual_private);
	$OUT .= "$virtual_private\n";
	$OUT .= "\n";
	$OUT .= "include /etc/ipsec.d/*.conf\n";
}
